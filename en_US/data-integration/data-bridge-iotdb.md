# Apache IoTDB Data Bridge

IoTDB is a high-performance and scalable timeseries database that is designed to
handle massive amounts of time series data generated by various IoT devices and
systems. This data bridge integrates with IoTDB, allowing you to forward data
from other systems to IoTDB for storage and analysis.

EMQX supports integration with IoTDB, allowing you to forward timeseries data to
[IoTDB](https://iotdb.apache.org/) using their [REST API
V2](https://iotdb.apache.org/UserGuide/Master/API/RestServiceV2.html).

{% emqxce %}
:::tip The IoTDB bridge is an EMQX Enterprise Edition feature. EMQX
Enterprise Edition provides comprehensive coverage of key business scenarios,
rich data integration, product-level reliability, and 24/7 global technical
support. Experience the benefits of this [enterprise-ready MQTT messaging
platform](https://www.emqx.com/en/try?product=enterprise) today.
::: {% endemqxce %}

::: tip Prerequisites

- Knowledge about EMQX data integration [rules](./rules.md)

- Knowledge about [data bridges](./data-bridges.md)

- Basic knowledge of UNIX terminal and commands

:::

## Feature List

- [Connection pool](./data-bridges.md)
- [Async mode](./data-bridges.md)
<!-- - [Batch mode](./data-bridges.md) -->
<!-- - [Buffer mode](./data-bridges.md) -->

## Quick Start Tutorial

This section introduces how to use the IoTDB data bridge with a practical
tutorial, covering topics like how to create an IoTDB instance, how to set up a
bridge, and how to set up a rule for forwarding data to the bridge and testing
that it all works.

This tutorial assumes that you have an IoTDB instance running on the local
machine. If you have IoTDB running remotely, please adjust the settings
accordingly.

Make sure to have `enable_rest_service=true` in your IoTDB's configuration.

### Start an IoTDB Server

This section introduces how to start an IoTDB server using [Docker](https://www.docker.com/).

Run the following command to start an IoTDB server with its REST interface enabled:

```bash
docker run -d --name iotdb-service \
              --hostname iotdb-service \
              -p 6667:6667 \
              -p 18080:18080 \
              -e enable_rest_service=true \
              -e cn_internal_address=iotdb-service \
              -e cn_target_config_node_list=iotdb-service:10710 \
              -e cn_internal_port=10710 \
              -e cn_consensus_port=10720 \
              -e dn_rpc_address=iotdb-service \
              -e dn_internal_address=iotdb-service \
              -e dn_target_config_node_list=iotdb-service:10710 \
              -e dn_mpp_data_exchange_port=10740 \
              -e dn_schema_region_consensus_port=10750 \
              -e dn_data_region_consensus_port=10760 \
              -e dn_rpc_port=6667 \
              apache/iotdb:1.1.0-standalone
```

You can find more information about running [IoTDB in Docker on Docker Hub](https://hub.docker.com/r/apache/iotdb).

### Create an IoTDB Data Bridge

Next, you can start creating an EMQX data bridge to IoTDB.

1. Go to the EMQX Dashboard, click **Data Integration -> Data Bridge**.
2. Click Create on the top right corner of the page.
3. In the **Create Data Bridge page**, click to select *IoTDB*, and then click Next.
4. Input a name for the data bridge. The name should be a combination of upper/lower case letters and numbers.
5. Input the connection information:
   * **Base URL**: Input "http//localhost:18080" or the actual hostname/IP if the IoTDB server is running remotely.
   * **Username**: Input the IoTDB username, default is root.
   * **Password**: Input the IoTDB password, default is root.
   * **Payload Template**: The payload template field allows you to define a custom message payload format that will be sent to the IoTDB exchange. You can use placeholders within the template to dynamically include data from the incoming MQTT messages. These placeholders are enclosed in `${}` and will be replaced by the actual values from the message when it is forwarded to the IoTDB server. For example, if you want to include the MQTT message payload and its timestamp in the IoTDB message, you can use the template like this: {"payload": "${data}", "timestamp": ${timestamp}}. This template will produce a JSON-formatted message containing the payload and timestamp of the incoming MQTT message. The default value for the payload template field is an empty string, which means the message payload will be forwarded to IoTDB without any modification as JSON formatted text.
6. Then click **Create** to finish the creation of the data bridge.

Now the IoTDB data bridge should appear in the data bridge list (**Data Integration -> Data Bridge**) with Resource Status as Connected. You can continue to create a rule to forward data to the new IoTDB bridge.

### Create a Rule for the IoTDB Bridge

1. Go to the EMQX Dashboard, click Data **Integration -> Rules**.
2. Click **Create** on the top right corner of the page.
3. Input a rule ID, for example, `my_rule`.
4. Input the following statement in the SQL editor, which will forward the MQTT messages matching the topic pattern t/#:

   ```
   SELECT
     *
   FROM
     "t/#"

   ```

5. Then click the **Add Action** button, select **Forwarding with Data Bridge** from the dropdown list, and then select the data bridge you just created under **Data Bridge**.
6. Click the **Add** button to finish the setup.
7. Click the **Create** button at the bottom of the page to finish the setup.

Now a rule to forward data to IoTDB via a IoTDB bridge is created. You can click **Data Integration -> Flows** to view the topology. It can be seen that the messages under the topic `t/#` are sent and saved to IoTDB.

### Test the Rule and Bridge

You can use the built-in WebSocket client in the EMQX dashboard to test our rule and bridge.

Click **Diagnose -> WebSocket** Client in the left navigation menu of the Dashboard to access the WebSocket Client.

1. Fill in the connection information for the current EMQX instance. If you are running EMQX locally, you can use the default values unless you have changed EMQX's default configuration (for example, you might have configured authentication which may require you to type in a username and password).
2. Click **Connect** to connect the client to the EMQX instance.
3. Scroll down to the publish area and type in the following:
   * **Topic**: t/test
   * **Payload**: Make sure to select `JSON` as the payload encoding and then enter
   ```json
   {
     "measurement": "temp",
     "data_type": "FLOAT",
     "value": "37.6",
     "device_id": "root.sg27"
   }
   ```
   * **QoS**: 2
4. Click **Publish** to send the message.

If everything has gone according to plan, a message should have been published
to the specified timeseries table in the IoTDB server. You can check this using IoTDB's command line interface. If you're using it from docker as above you can connect by using this command from your terminal:

```shell
    $ docker exec -ti iotdb-service /iotdb/sbin/start-cli.sh -h iotdb-service
```

Then from within this console you type
```sql
IoTDB> select * from root.sg27
```
And you should see something like this
```
+------------------------+--------------+
|                    Time|root.sg27.temp|
+------------------------+--------------+
|2023-05-05T14:26:44.743Z|          37.6|
+------------------------+--------------+
```
