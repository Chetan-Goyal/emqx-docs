# OCPP Protocol Gateway

## Protocol Introduction

[OCPP (Open Charge Point Protocol)](https://www.openchargealliance.org/)
is a communication protocol used between Charge Points and a Central System to
enable the monitoring and control of EV (Electric Vehicle) charging sessions.

Since e4.4.18, EMQX has implemented the `emqx_ocpp` plugin based on the
[OCCP-J 1.6](https://www.openchargealliance.org/protocols/ocpp-16/) standard, providing the ability
to connect to Charge Point devices.

::: note
The current implementation is only provided as a plugin and does not support modules at this time.
:::

## Quick Start

All configurations of the OCPP plugin are located in the `plugins/emqx_ocpp.conf` file under the
EMQX etc directory.

Just execute the following command to start the OCPP plugin with default configuration file:
```bash
emqx_ctl plugins load emqx_ocpp
```

### Connect to OCPP Gateway

After the plugin is successfully loaded, you can use [ocpp-go](https://github.com/lorenzodonini/ocpp-go)
to simulate a Charge Point for connection testing.

Please follow the instructions provided in the ocpp-go documentation to complete the compilation
first, and then execute the following command to connect to EMQX's OCPP gateway.

Note: `<host>` needs to be modified to the address of your actual EMQX node.
```bash
CLIENT_ID=chargePointSim CENTRAL_SYSTEM_URL=ws://<host>:33033/ocpp go run example/1.6/cp/*.go
```

## ClientInfo and connection

The OCPP gateway only accept the clients by Websocket, as defined in the OCPP-J 1.6 protocol.

Once the connection is established successfully, EMQX treats it as a standard client. This means
that you can manage this client through Client ID on Dashboard/HTTP-API/CLI.

The mapping of client information is as follows:
- Client ID: The unique identifier of the Charge Point.
- Username: Obtained from HTTP Basic authentication provided by the Charge Point during connection.
- Password: Also obtained from HTTP Basic authentication.


### Authentication

As mentioned in the OCPP-J 1.6 specification, Charge Points can use HTTP Basic for authentication.
The OCPP gateway extracts the Username and Password from it and uses EMQX's authentication system
to determine whether the client has access permission.

You can refer to [Authentication](../advanced/auth.md) for configuration.

## Messaging conversion

```
                                +--------------+  upstream publish  +---------+
+--------------+   Req/Resp     | OCPP Gateway | -----------------> | Third   |
| Charge Point | <------------> | over         |     over Topic     | Service |
+--------------+   over ws/wss  | EMQX         | <----------------- |         |
                                +--------------+  dnstream publish  +---------+
```

As shown in the figure:
- Communication between Charge Point and OCPP gateway is based on the OCPP-J specification,
  based on Websocket or Websocket over TLS.
- The OCPP gateway converts Charge Point messages into a standard MQTT Publish message. The topic and
  message connect are defined by the OCPP gateway.
- Third-party systems receive messages from Charge Points by subscribing to upstream topics;
  they also push control messages to Charge Points by sending messages to downstream topics.
- The OCPP gateway is only responsible for formatting conversion and forwarding of
   upstream/downstream messages.
   Any business-related implementation such as charging initiation and billing needs to be handled
   by your third-party systems.

### Up Stream (emqx-ocpp -> third-services)

The OCPP gateway publishes messages and events generated by the Charge Point through EMQX.
This data flow is called **Up Stream**.

The topic supports configuration in any format, for example:
```
## plugins/emqx_ocpp.conf
##
## Default upstream topic.
## The emqx_ocpp gateway will publish all Charge Point messages to this topic.
##
## Available placeholders are:
## - cid: Charge Point ID
## - action: The Message Name for OCPP
ocpp.upstream.topic = ocpp/cp/${cid}/${action}

## Also, supports overriding the default topic by message name
##
ocpp.upstream.topic.BootNotification = ocpp/cp/${cid}/Notify/${action}
```

The message content (Payload) is a JSON string with a fixed pattern, which includes fields:

| Field             | Type        | Required | Desc |
| ----------------- | ----------- | -------- | ---- |
| MessageTypeId     | MessageType | R        | Define the type of Message, whether it is Call, CallResult or CallError |
| UniqueId          | String      | R        | This must be the exact same id that is in the call request so that the recipient can match request and result |
| Action            | String      | O        | The Message Name of OCPP. E.g. Authorize |
| ErrorCode         | ErrorType   | O        | The string must contain one from ErrorType Table |
| ErrorDescription  | String      | O        | Detailed Error information |
| Payload           | Bytes       | O        | Payload field contains the serialized strings of bytes for protobuf format of OCPP message |

Similarly, for response messages and error notifications sent by Charge Point to third-party services,
their topic formats can also be customized:

```
## plugins/emqx_ocpp.conf

ocpp.upstream.reply_topic = ocpp/cp/Reply/${cid}
ocpp.upstream.error_topic = ocpp/cp/Error/${cid}
```


### Down Stream (third-services -> emqx-ocpp)

The control messages for the Charge Point can be issued by third-party systems through the topics
configured in the OCPP gateway. This data flow is called **Down Stream**.

The topic supports configuration in any format, such as:
```
## plugins/emqx_ocpp.conf
##
## Downstream topic.
## The gateway will automatically subscribe to this topic for each connected Charge Point gateway
## to receive downstream control commands.
##
## Available placeholders are:
## - cid: Charge Point ID
##
## Note:
##  1. ${cid} is required to distinguish each Charge Point
##  2. The wildcard `+` is not necessary, it's just an example here.
ocpp.dnstream.topic = ocpp/${cid}/+/+
```

The payload of a downstream message is a JSON string with a fixed pattern, similar to upstream.

For example, the response message from a third-party system sent to the gateway for BootNotification has the following format:
```
Topic: ocpp/cp/CP001/Reply/BootNotification
Payload:
  {"MessageTypeId": 3,
   "UniqueId": "1",
   "Payload": {"currentTime": "2022-06-21T14:20:39+00:00", "interval": 300, "status": "Accepted"}
  }
```
